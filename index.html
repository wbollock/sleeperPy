<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <title>SleeperPy</title>
    <meta name="author" content="Will Bollock">
    <link rel="stylesheet" href="tiers/style.css">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/main.css">
    <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
    body {
      background: #1e2636 !important;
      color: #eaf0fa;
      font-family: 'Raleway', 'Roboto', Arial, sans-serif;
      min-height: 100vh;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
      padding: 30px 10px 10px 10px;
    }
    .homepageHeader {
      text-align: center;
      font-size: 2.2em;
      margin-bottom: 0.2em;
      color: #eaf0fa;
      letter-spacing: 1px;
    }
    #userform {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    #inputButton {
      font-size: 1.1em;
      padding: 12px 16px;
      border-radius: 6px;
      border: 1px solid #3a4a6e;
      background: #232c41;
      color: #eaf0fa;
      width: 260px;
      margin-bottom: 0.5em;
      box-shadow: 0 1px 4px rgba(30,38,54,0.08);
    }
    #generateTiers {
      font-size: 1.1em;
      padding: 12px 32px 16px 32px; /* Increased bottom padding to 16px */
      border-radius: 6px;
      border: none;
      background: #3a6ee8;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      margin-bottom: 0.5em;
      box-shadow: 0 2px 8px rgba(58,110,232,0.10);
      letter-spacing: 0.5px;
    }
    #generateTiers:hover {
      background: #254a99;
      box-shadow: 0 4px 16px rgba(58,110,232,0.18);
    }
    #output {
      margin-top: 24px;
      margin-bottom: 24px;
      color: #eaf0fa;
    }
    table.table-fill {
      background: #f4f7fb;
      border-radius: 10px;
      border-collapse: collapse;
      margin: 0 auto 30px auto;
      width: 100%;
      box-shadow: 0 2px 12px rgba(30,38,54,0.13);
      font-size: 1em;
      color: #27324a;
    }
    .table-fill th, .table-fill td {
      padding: 12px 10px;
      text-align: left;
    }
    .table-fill th {
      background: #c9d4e7;
      color: #1a2233;
      font-weight: 600;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      letter-spacing: 0.5px;
    }
    .table-fill tr:nth-child(even) td {
      background: #eaf0fa;
    }
    .table-fill tr:hover td {
      background: #d2e0f7;
    }
    .table-fill td {
      border-bottom: 1px solid #c3d3ea;
    }
    h3 {
      text-align: center;
      margin-top: 1.5em;
      margin-bottom: 0.5em;
      color: #7bb0ff;
      letter-spacing: 0.5px;
    }
    footer {
      text-align: center;
      margin-top: 40px;
      color: #7bb0ff;
      font-size: 0.95em;
    }
    @media (max-width: 600px) {
      .container { padding: 10px 2px; }
      #inputButton { width: 98vw; max-width: 98vw; }
      table.table-fill { font-size: 0.95em; }
    }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script>
    const proxy = url => `http://localhost:5001/proxy?url=${encodeURIComponent(url)}`;

// Helper: fetch and cache all NFL players
let allPlayers = null;
async function getAllPlayers() {
    if (allPlayers) return allPlayers;
    let res = await fetch(proxy('https://api.sleeper.app/v1/players/nfl'));
    allPlayers = await res.json();
    return allPlayers;
}

// Helper: fetch and cache Boris Chen tiers for all positions
let borisTiers = {};
const tierUrls = {
    QB: 'https://s3-us-west-1.amazonaws.com/fftiers/out/text_QB.txt',
    RB: 'https://s3-us-west-1.amazonaws.com/fftiers/out/text_RB-PPR.txt',
    WR: 'https://s3-us-west-1.amazonaws.com/fftiers/out/text_WR-PPR.txt',
    TE: 'https://s3-us-west-1.amazonaws.com/fftiers/out/text_TE-PPR.txt',
    K:  'https://s3-us-west-1.amazonaws.com/fftiers/out/text_K.txt',
    DST:'https://s3-us-west-1.amazonaws.com/fftiers/out/text_DST.txt',
};

async function getBorisTiers() {
    if (Object.keys(borisTiers).length) return borisTiers;
    for (let pos in tierUrls) {
        let txt = await fetch(proxy(tierUrls[pos])).then(r => r.text());
        borisTiers[pos] = txt.split('\n').filter(Boolean);
    }
    return borisTiers;
}

// Normalize names for matching
function normalizeName(name) {
    return name.toLowerCase().replace(/\./g, '').replace(/ jr| sr| ii| iii| iv| v/g, '').replace(/[^a-z0-9 ]/g, '').replace(/\s+/g, ' ').trim();
}

// Find tier for a player name in a tier list
function findTier(tierList, fullName) {
    let norm = normalizeName(fullName);
    for (let i = 0; i < tierList.length; ++i) {
        let names = tierList[i].replace(/^Tier \d+: /, '').split(',').map(x => normalizeName(x));
        if (names.includes(norm)) return i+1;
    }
    return null;
}

async function fetchTiers(event) {
    event.preventDefault();
    const username = document.getElementById('inputButton').value.trim();
    const output = document.getElementById('output');

    if (!username.match(/^[\w.-]+$/)) {
        output.innerHTML = '<span style="color:red">Please enter a valid username (letters, numbers, ".", "-", "_").</span>';
        return;
    }

    output.innerHTML = 'Loading...';

    try {
        // 1. Get user ID
        let res = await fetch(proxy(`https://api.sleeper.app/v1/user/${username}`));
        if (!res.ok) throw new Error('User not found');
        let user = await res.json();
        let userId = user.user_id;

        // 2. Get leagues
        const year = new Date().getFullYear();
        res = await fetch(proxy(`https://api.sleeper.app/v1/user/${userId}/leagues/nfl/${year}`));
        let leagues = await res.json();
        if (!leagues.length) throw new Error('No leagues found for this user.');

        // 3. Get current NFL week from Sleeper API
        let weekRes = await fetch(proxy('https://api.sleeper.app/v1/state/nfl'));
        let state = await weekRes.json();
        let week = state.week;
        console.log('Current NFL week:', week);

        // 4. Get all players and tiers
        let players = await getAllPlayers();
        let tiers = await getBorisTiers();

        // 5. Fetch all rosters and matchups in parallel
        let rosterPromises = leagues.map(league => fetch(proxy(`https://api.sleeper.app/v1/league/${league.league_id}/rosters`)).then(r => r.json()));
        let matchupPromises = leagues.map(league => fetch(proxy(`https://api.sleeper.app/v1/league/${league.league_id}/matchups/${week}`)).then(r => r.json()));
        let allRosters = await Promise.all(rosterPromises);
        let allMatchups = await Promise.all(matchupPromises);

        // 6. For each league, process data
        let html = '';
        for (let i = 0; i < leagues.length; ++i) {
            let league = leagues[i];
            let leagueId = league.league_id;
            let leagueName = league.name;
            let scoring = league.scoring_settings.rec;
            let rosters = allRosters[i];
            let matchups = allMatchups[i];

            // Validate matchups exist
            if (!matchups || matchups.length === 0) {
                console.log(`No matchups found for league ${leagueName} week ${week}`);
                continue;
            }

            let userRoster = rosters.find(team => team.owner_id === userId);
            if (!userRoster) continue;

            let starters = userRoster.starters;
            let all = userRoster.players;
            let bench = all.filter(pid => !starters.includes(pid));

            // Find opponent starters
            let myMatchup = matchups.find(m => m.roster_id === userRoster.roster_id);
            let oppMatchup = matchups.find(m => m.matchup_id === (myMatchup && myMatchup.matchup_id) && m.roster_id !== userRoster.roster_id);
            let oppStarters = oppMatchup ? oppMatchup.starters : [];

            // Debug output
            console.log('League:', leagueName);
            console.log('My matchup:', myMatchup);
            console.log('Opponent matchup:', oppMatchup);
            console.log('Opponent starters:', oppStarters);

            // Map player IDs to info for starters, bench, opponent
            function getTierAndName(pid) {
                let p = players[pid];
                if (!p) return {name: pid, pos: '?', tier: null};

                let isFlexSlot = false;
                if (Array.isArray(starters) && starters.includes(pid)) {
                    let idx = starters.indexOf(pid);
                    if (userRoster && Array.isArray(userRoster.starter_positions)) {
                        let slotName = userRoster.starter_positions[idx];
                        if (slotName && slotName.toUpperCase().includes('FLEX')) isFlexSlot = true;
                    }
                }

                let realPos = p.position;
                let pos = isFlexSlot ? 'FLEX' : realPos;
                let name;
                let tier = null;
                let lookupPos = realPos;

                if (lookupPos === 'DEF' || lookupPos === 'DST') {
                    name = TEAM_MAP[p.team] || p.team || 'Unknown';
                    let tierList = tiers['DST'];
                    if (tierList) tier = findTier(tierList, name);
                } else {
                    name = (p.first_name || '') + ' ' + (p.last_name || '');
                    if (isFlexSlot) name += ' <span style="color:#7bb0ff;font-size:0.95em;">(FLEX)</span>';
                    if (tiers[lookupPos]) tier = findTier(tiers[lookupPos], (p.first_name || '') + ' ' + (p.last_name || ''));
                }
                return {name, pos, tier};
            }

            // Starters
            let starterRows = [];
            let starterTiers = [];
            let starterUnranked = [];
            for (let pid of starters) {
                let {name, pos, tier} = getTierAndName(pid);
                let flexLabel = (pos === 'FLEX') ? ' <span style="color:#7bb0ff;font-size:0.95em;">(FLEX)</span>' : '';
                if (tier) {
                    starterRows.push(`<tr><td>${pos}</td><td>${name}${flexLabel}</td><td>${tier}</td></tr>`);
                    starterTiers.push(tier);
                } else {
                    starterUnranked.push(`<tr><td>?</td><td>${name}${flexLabel}</td><td>Not Ranked</td></tr>`);
                }
            }

            // Opponent average tier
            let oppTiers = [];
            for (let pid of oppStarters) {
                if (!pid) continue;
                let {tier} = getTierAndName(pid);
                if (typeof tier === 'number' && !isNaN(tier)) oppTiers.push(tier);
            }

            // Bench
            let benchRows = [];
            let benchUnranked = [];
            for (let pid of bench) {
                let {name, pos, tier} = getTierAndName(pid);
                if (tier) {
                    benchRows.push(`<tr><td>${pos}</td><td>${name}</td><td>${tier}</td></tr>`);
                } else {
                    benchUnranked.push(`<tr><td>?</td><td>${name}</td><td>Not Ranked</td></tr>`);
                }
            }

            // Average tier calculations
            function avg(arr) {
                let nums = arr.filter(x => typeof x === 'number' && !isNaN(x));
                if (!nums.length) return '-';
                let sum = nums.reduce((a,b) => a+b, 0);
                return (sum/nums.length).toFixed(2);
            }

            let avgTier = avg(starterTiers);
            let avgOppTier = avg(oppTiers);

            // Win probability
            let winProb = '-';
            let emoji = '🤝';
            if (avgTier !== '-' && avgOppTier !== '-') {
                let diff = avgOppTier - avgTier;
                let prob = 50 + Math.max(-30, Math.min(30, diff * 10));
                if (prob > 60) { emoji = '🏆'; } else if (prob < 40) { emoji = '💀'; }
                winProb = `${prob.toFixed(0)}% ${prob > 50 ? 'You' : 'Opponent'} ${emoji}`;
            }

            // Output
            html += `<h3>${leagueName} (PPR)</h3><table class="table-fill"><tr><th>Position</th><th>Player</th><th>Tier</th></tr>`;
            html += starterRows.join('');
            html += starterUnranked.join('');
            html += `<tr><td colspan="3" style="text-align:center;"><b>Average Tier: ${avgTier}</b></td></tr>`;
            html += `<tr><td colspan="3" style="text-align:center;"><b>Opponent Average Tier: ${avgOppTier}</b></td></tr>`;
            html += `<tr><td colspan="3" style="text-align:center;"><b>Win Probability: ${winProb}</b></td></tr>`;
            html += `<tr><th colspan="3" style="text-align:center;">Bench</th></tr>`;
            html += benchRows.join('');
            html += benchUnranked.join('');
            html += '</table><br>';
        }

        output.innerHTML = html;
    } catch (err) {
        output.innerHTML = `<span style='color:red'>Error: ${err.message}</span>`;
    }
}

// Add mapping for DST/DEF: Sleeper team abbrev to full name
const TEAM_MAP = {
    ARI: 'Arizona Cardinals', ATL: 'Atlanta Falcons', BAL: 'Baltimore Ravens', BUF: 'Buffalo Bills',
    CAR: 'Carolina Panthers', CHI: 'Chicago Bears', CIN: 'Cincinnati Bengals', CLE: 'Cleveland Browns',
    DAL: 'Dallas Cowboys', DEN: 'Denver Broncos', DET: 'Detroit Lions', GB: 'Green Bay Packers',
    HOU: 'Houston Texans', IND: 'Indianapolis Colts', JAX: 'Jacksonville Jaguars', KC: 'Kansas City Chiefs',
    LV: 'Las Vegas Raiders', LAC: 'Los Angeles Chargers', LAR: 'Los Angeles Rams', MIA: 'Miami Dolphins',
    MIN: 'Minnesota Vikings', NE: 'New England Patriots', NO: 'New Orleans Saints', NYG: 'New York Giants',
    NYJ: 'New York Jets', PHI: 'Philadelphia Eagles', PIT: 'Pittsburgh Steelers', SEA: 'Seattle Seahawks',
    SF: 'San Francisco 49ers', TB: 'Tampa Bay Buccaneers', TEN: 'Tennessee Titans', WAS: 'Washington Commanders'
};

    </script>
</head>
<body>
<div class="container">
    <div class="row centerinput">
        <h1 class="homepageHeader"><a href="https://wboll.dev/sleeperPy">SleeperPy</a></h1>
        <h5 id="infoText" style="text-align:left;">Displays your team's <a href="http://www.borischen.co/">Boris Chen</a> tiers across all Sleeper leagues.</h5>
        <form id="userform" onsubmit="fetchTiers(event)">
            <input id="inputButton" type="text" name="name" required placeholder="Sleeper Username">
            <br>
            <input id="generateTiers" type="submit" value="Show My Tiers">
        </form>
        <div id="output" style="margin-top:20px;"></div>
        <br><br>
    </div>
</div>
<div class="container">
    <div class="row centerinput">
        <footer>
            <ul>
                <li>In the "Tiers" column, lower is better.</li>
                <li><a href="https://github.com/wbollock/sleeperPy">GitHub Repo</a> | 
                <a href="http://www.borischen.co/">Source of Tiers</a> | 
                <a href="https://codepen.io/alassetter/pen/cyrfB">CSS Table Styling</a> | 
                <a href="http://getskeleton.com/">General Styling</a>
                </li>
            </ul>
        </footer>
    </div>
</div>
</body>
</html>
