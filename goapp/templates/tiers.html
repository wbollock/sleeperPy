{{if .Error}}
<span style="color:red">{{.Error}}</span>
{{else}}
<div class="league-tabs">
    {{range $i, $l := .Leagues}}
        <button class="league-tab" onclick="showLeagueTab(event, 'league{{$i}}')" {{if eq $i 0}}id="defaultTab"{{end}}>{{$l.LeagueName}} ({{$l.Scoring}})</button>
    {{end}}
</div>
<div class="league-contents">
    {{range $i, $l := .Leagues}}
        {{$display := "none"}}
        {{if eq $i 0}}{{$display = "block"}}{{end}}
        <div class="league-content" id="league{{$i}}" style="display:{{$display}};">
            <table class="sortable-table pretty-table">
                <thead>
                    <tr><th>Position</th><th>Player</th><th>Tier</th></tr>
                </thead>
                <tbody>
                {{range $l.Starters}}
                    <tr{{if eq .Tier 1}} class="tier1"{{else if .IsTierWorseThanBench}} class="tier-worse"{{end}}><td>{{.Pos}}</td><td>{{if eq .Tier 1}}<span class="tier1-star">★</span> {{end}}{{.Name | safe}}</td><td>{{.Tier}}</td></tr>
                {{end}}
                {{range $l.Unranked}}
                    <tr><td>{{.Pos}}</td><td>{{.Name | safe}}</td><td>{{.Tier}}</td></tr>
                {{end}}
                </tbody>
                <tfoot>
                    <tr><td colspan="3" class="summary"><b>Average Tier: {{$l.AvgTier}}</b></td></tr>
                    <tr><td colspan="3" class="summary"><b>Opponent Average Tier: {{$l.AvgOppTier}}</b></td></tr>
                                        <tr>
                                            <td colspan="3" class="summary">
                                                <div class="winprob-row">
                                                    <span class="winprob-label">Win Probability:</span>
                                                    <span class="winprob-bar-wrap">
                                                        <span class="winprob-bar-bg">
                                                            <span class="winprob-bar" style="width: {{parseWinProb $l.WinProb}}%; background: {{winProbColor $l.WinProb}};"></span>
                                                        </span>
                                                    </span>
                                                    <span class="winprob-badge" style="background: {{winProbColor $l.WinProb}};">
                                                        {{parseWinProb $l.WinProb}}%
                                                    </span>
                                                    <span class="winprob-emoji">{{parseWinEmoji $l.WinProb}}</span>
                                                </div>
                                            </td>
                                        </tr>
                    <tr><th colspan="3" class="bench-header">Bench</th></tr>
                    {{range $l.Bench}}
                        <tr{{if eq .Tier 1}} class="tier1"{{else if .ShouldSwapIn}} class="swap-candidate"{{end}}><td>{{.Pos}}</td><td>{{if eq .Tier 1}}<span class="tier1-star">★</span> {{end}}{{if .ShouldSwapIn}}<span class="swap-icon">⇄</span> {{end}}{{.Name | safe}}</td><td>{{.Tier}}</td></tr>
                    {{end}}
                    {{range $l.BenchUnranked}}
                        <tr><td>{{.Pos}}</td><td>{{.Name | safe}}</td><td>{{.Tier}}</td></tr>
                    {{end}}
                </tfoot>
            </table>
            <br>
            <div class="fa-section">
                <div class="fa-header">Top Free Agents (Top 3 per Position)</div>
                <div class="fa-tabs">
                    {{ $first := true }}
                    {{ with index $l.FreeAgentsByPos "QB" }}<button class="fa-tab" onclick="showFATab(event, 'fa-{{$i}}-QB')" {{if $first}}id="defaultFATab{{$i}}"{{end}}>QB</button>{{ $first = false }}{{ end }}
                    {{ with index $l.FreeAgentsByPos "RB" }}<button class="fa-tab" onclick="showFATab(event, 'fa-{{$i}}-RB')">RB</button>{{ end }}
                    {{ with index $l.FreeAgentsByPos "WR" }}<button class="fa-tab" onclick="showFATab(event, 'fa-{{$i}}-WR')">WR</button>{{ end }}
                    {{ with index $l.FreeAgentsByPos "TE" }}<button class="fa-tab" onclick="showFATab(event, 'fa-{{$i}}-TE')">TE</button>{{ end }}
                    {{ with index $l.FreeAgentsByPos "DST" }}<button class="fa-tab" onclick="showFATab(event, 'fa-{{$i}}-DST')">DST</button>{{ end }}
                    {{ with index $l.FreeAgentsByPos "K" }}<button class="fa-tab" onclick="showFATab(event, 'fa-{{$i}}-K')">K</button>{{ end }}
                </div>
                <div class="fa-tab-contents">
                    {{ $first := true }}
                    {{ with $faList := index $l.FreeAgentsByPos "QB" }}
                        {{$display := "none"}}{{if $first}}{{$display = "block"}}{{end}}
                        <div class="fa-tab-content" id="fa-{{$i}}-QB" style="display:{{$display}};">
                            <table class="sortable-table pretty-table fa-table">
                                <thead>
                                    <tr><th colspan="3" class="fa-pos-header">QB</th></tr>
                                    <tr><th>Position</th><th>Player</th><th>Tier</th></tr>
                                </thead>
                                <tbody>
                                {{range $faList}}
                                    <tr{{if .IsUpgrade}} class="fa-upgrade"{{end}}>
                                        <td>{{.Pos}}</td>
                                        <td>{{.Name | safe}}
                                            {{if .IsUpgrade}}
                                                <span class="fa-upgrade-icon">⬆️</span>
                                                <span class="fa-upgrade-for">
                                                    (Upgrade for {{.UpgradeType}}: {{.UpgradeFor}})
                                                </span>
                                            {{end}}
                                        </td>
                                        <td>{{.Tier}}</td>
                                    </tr>
                                {{end}}
                                </tbody>
                            </table>
                        </div>
                        {{ $first = false }}
                    {{ end }}
                    {{ with $faList := index $l.FreeAgentsByPos "RB" }}
                        <div class="fa-tab-content" id="fa-{{$i}}-RB" style="display:none;">
                            <table class="sortable-table pretty-table fa-table">
                                <thead>
                                    <tr><th colspan="3" class="fa-pos-header">RB</th></tr>
                                    <tr><th>Position</th><th>Player</th><th>Tier</th></tr>
                                </thead>
                                <tbody>
                                {{range $faList}}
                                    <tr{{if .IsUpgrade}} class="fa-upgrade"{{end}}>
                                        <td>{{.Pos}}</td>
                                        <td>{{.Name | safe}}
                                            {{if .IsUpgrade}}
                                                <span class="fa-upgrade-icon">⬆️</span>
                                                <span class="fa-upgrade-for">
                                                    (Upgrade for {{.UpgradeType}}: {{.UpgradeFor}})
                                                </span>
                                            {{end}}
                                        </td>
                                        <td>{{.Tier}}</td>
                                    </tr>
                                {{end}}
                                </tbody>
                            </table>
                        </div>
                    {{ end }}
                    {{ with $faList := index $l.FreeAgentsByPos "WR" }}
                        <div class="fa-tab-content" id="fa-{{$i}}-WR" style="display:none;">
                            <table class="sortable-table pretty-table fa-table">
                                <thead>
                                    <tr><th colspan="3" class="fa-pos-header">WR</th></tr>
                                    <tr><th>Position</th><th>Player</th><th>Tier</th></tr>
                                </thead>
                                <tbody>
                                {{range $faList}}
                                    <tr{{if .IsUpgrade}} class="fa-upgrade"{{end}}>
                                        <td>{{.Pos}}</td>
                                        <td>{{.Name | safe}}
                                            {{if .IsUpgrade}}
                                                <span class="fa-upgrade-icon">⬆️</span>
                                                <span class="fa-upgrade-for">
                                                    (Upgrade for {{.UpgradeType}}: {{.UpgradeFor}})
                                                </span>
                                            {{end}}
                                        </td>
                                        <td>{{.Tier}}</td>
                                    </tr>
                                {{end}}
                                </tbody>
                            </table>
                        </div>
                    {{ end }}
                    {{ with $faList := index $l.FreeAgentsByPos "TE" }}
                        <div class="fa-tab-content" id="fa-{{$i}}-TE" style="display:none;">
                            <table class="sortable-table pretty-table fa-table">
                                <thead>
                                    <tr><th colspan="3" class="fa-pos-header">TE</th></tr>
                                    <tr><th>Position</th><th>Player</th><th>Tier</th></tr>
                                </thead>
                                <tbody>
                                {{range $faList}}
                                    <tr{{if .IsUpgrade}} class="fa-upgrade"{{end}}>
                                        <td>{{.Pos}}</td>
                                        <td>{{.Name | safe}}
                                            {{if .IsUpgrade}}
                                                <span class="fa-upgrade-icon">⬆️</span>
                                                <span class="fa-upgrade-for">
                                                    (Upgrade for {{.UpgradeType}}: {{.UpgradeFor}})
                                                </span>
                                            {{end}}
                                        </td>
                                        <td>{{.Tier}}</td>
                                    </tr>
                                {{end}}
                                </tbody>
                            </table>
                        </div>
                    {{ end }}
                    {{ with $faList := index $l.FreeAgentsByPos "DST" }}
                        <div class="fa-tab-content" id="fa-{{$i}}-DST" style="display:none;">
                            <table class="sortable-table pretty-table fa-table">
                                <thead>
                                    <tr><th colspan="3" class="fa-pos-header">DST</th></tr>
                                    <tr><th>Position</th><th>Player</th><th>Tier</th></tr>
                                </thead>
                                <tbody>
                                {{range $faList}}
                                    <tr{{if .IsUpgrade}} class="fa-upgrade"{{end}}>
                                        <td>{{.Pos}}</td>
                                        <td>{{.Name | safe}}
                                            {{if .IsUpgrade}}
                                                <span class="fa-upgrade-icon">⬆️</span>
                                                <span class="fa-upgrade-for">
                                                    (Upgrade for {{.UpgradeType}}: {{.UpgradeFor}})
                                                </span>
                                            {{end}}
                                        </td>
                                        <td>{{.Tier}}</td>
                                    </tr>
                                {{end}}
                                </tbody>
                            </table>
                        </div>
                    {{ end }}
                    {{ with $faList := index $l.FreeAgentsByPos "K" }}
                        <div class="fa-tab-content" id="fa-{{$i}}-K" style="display:none;">
                            <table class="sortable-table pretty-table fa-table">
                                <thead>
                                    <tr><th colspan="3" class="fa-pos-header">K</th></tr>
                                    <tr><th>Position</th><th>Player</th><th>Tier</th></tr>
                                </thead>
                                <tbody>
                                {{range $faList}}
                                    <tr{{if .IsUpgrade}} class="fa-upgrade"{{end}}>
                                        <td>{{.Pos}}</td>
                                        <td>{{.Name | safe}}
                                            {{if .IsUpgrade}}
                                                <span class="fa-upgrade-icon">⬆️</span>
                                                <span class="fa-upgrade-for">
                                                    (Upgrade for {{.UpgradeType}}: {{.UpgradeFor}})
                                                </span>
                                            {{end}}
                                        </td>
                                        <td>{{.Tier}}</td>
                                    </tr>
                                {{end}}
                                </tbody>
                            </table>
                        </div>
                    {{ end }}
                </div>
            </div>
        </div>
    {{end}}
</div>
<style>
.fa-section { margin-top: 2em; }
.fa-header { font-size: 1.2em; font-weight: bold; margin-bottom: 0.5em; }
.fa-tabs { margin-bottom: 1em; }
.fa-tab { background: #f2f2f2; border: 1px solid #ccc; border-bottom: none; padding: 0.5em 1.2em; cursor: pointer; font-weight: bold; margin-right: 0.2em; border-radius: 6px 6px 0 0; }
.fa-tab.active, .fa-tab:focus { background: #e0eaff; color: #1a237e; border-bottom: 2px solid #1a237e; outline: none; }
.fa-tab-content { padding: 0.5em 0; }
.fa-upgrade { background: #eaffea; }
.fa-upgrade-icon { color: #2e7d32; font-weight: bold; }
.fa-upgrade-for { color: #2e7d32; font-size: 0.95em; margin-left: 0.3em; }
.fa-pos-header { background: #f7f7f7; font-size: 1.1em; }
</style>
<script>
function showLeagueTab(evt, tabId) {
    document.querySelectorAll('.league-content').forEach(div => div.style.display = 'none');
    document.getElementById(tabId).style.display = 'block';
    document.querySelectorAll('.league-tab').forEach(btn => btn.classList.remove('active'));
    evt.currentTarget.classList.add('active');
}
if (document.getElementById('defaultTab')) document.getElementById('defaultTab').click();

function showFATab(evt, tabId) {
    var parent = evt.currentTarget.closest('.fa-section');
    parent.querySelectorAll('.fa-tab-content').forEach(div => div.style.display = 'none');
    parent.querySelectorAll('.fa-tab').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabId).style.display = 'block';
    evt.currentTarget.classList.add('active');
}
// Auto-select first FA tab for each league
document.querySelectorAll('[id^=defaultFATab]').forEach(function(tab){ tab.click(); });
</script>
<script src="/static/sortable.js"></script>
{{end}}
